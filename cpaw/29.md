# Q29.[Crypto] Common World

<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>

>Cpaw君は,以下の公開鍵を用いて暗号化された暗号文Cを受け取りました．しかしCpaw君は秘密鍵を忘れてしまいました.Cpaw君のために暗号文を解読してあげましょう.  
>  
>(e, N) = (11, 236934049743116267137999082243372631809789567482083918717832642810097363305512293474568071369055296264199854438630820352634325357252399203160052660683745421710174826323192475870497319105418435646820494864987787286941817224659073497212768480618387152477878449603008187097148599534206055318807657902493850180695091646575878916531742076951110529004783428260456713315007812112632429296257313525506207087475539303737022587194108436132757979273391594299137176227924904126161234005321583720836733205639052615538054399452669637400105028428545751844036229657412844469034970807562336527158965779903175305550570647732255961850364080642984562893392375273054434538280546913977098212083374336482279710348958536764229803743404325258229707314844255917497531735251105389366176228741806064378293682890877558325834873371615135474627913981994123692172918524625407966731238257519603614744577)  
>  
> 暗号文:  
> 80265690974140286785447882525076768851800986505783169077080797677035805215248640465159446426193422263912423067392651719120282968933314718780685629466284745121303594495759721471318134122366715904  
>  
> [これは…？](https://ctf.cpaw.site/download.php?param=8a53ea3e483e88ac5a8b45787f2df9bd)  
>  
> フラグは以下のシンタックスです.  
> cpaw{復号した値}

リンク先のヒントは以下の通り。

> Cpaw君は自力では解けないのでRSA暗号のプロに尋ねるとヒントをくれました.  
>  
> (e, N) = (13, 236934049743116267137999082243372631809789567482083918717832642810097363305512293474568071369055296264199854438630820352634325357252399203160052660683745421710174826323192475870497319105418435646820494864987787286941817224659073497212768480618387152477878449603008187097148599534206055318807657902493850180695091646575878916531742076951110529004783428260456713315007812112632429296257313525506207087475539303737022587194108436132757979273391594299137176227924904126161234005321583720836733205639052615538054399452669637400105028428545751844036229657412844469034970807562336527158965779903175305550570647732255961850364080642984562893392375273054434538280546913977098212083374336482279710348958536764229803743404325258229707314844255917497531735251105389366176228741806064378293682890877558325834873371615135474627913981994123692172918524625407966731238257519603614744577)  
>  
> 暗号文:  
>14451037575679461333658489727928902053807202350950440400755535465672646289383249206721118279217195146247129636809289035793102103248547070620691905918862697416910065303500798664102685376006097589955370023822867897020714767877873664

まず本問は、RSA 暗号について、二つの公開鍵 $$(e_1, N)$$, $$(e_2, N)$$ と、それである平文を encrypto した暗号 $$c_1$$, $$c_2$$ が与えられている。  
このように、共通の $$N$$ を持った二つの公開鍵と、それで encrypto した二つの暗号文が与えられ、かつ $$e_1, e_2$$ が互いに素であるとき、**Common Modulus Attack** という方法で平文を求めることができる。

## RSA 暗号 復習
- 公開鍵: $$(e, N)$$
- 秘密鍵: $$d$$
- 平文: m
- 暗号文: c

とすると、

- 暗号化: $$c = m^e ~ (mod N) ~ \cdots$$
- 復号: $$ m = c^d ~ (mod N) ~ \cdots$$

## Common Modulus Attack
まず拡張ユークリッドの互除法を用いて、$$e_1x + e_2y = gcd(e_1, e_2) ( = 1)$$ なる $$x, y$$ を求める。  
ここで、$$c_1^{x} c_2^{y}$$ を計算してみると、
$$ c_1^{x} c_2^{y} = m^{e_1x} m^{e_2y} = m^{e_1x + e_2y} = m$$
となる。  
このように、$$c_1^{x} c_2^{y}$$ を計算することで平文を求めることができる。  

参考: https://blog.akashisn.info/entry/2018/08/07/132209

## 拡張ユークリッドの互除法
$$ax + by = gcd(a, b)$$ なる$$x, y$$ を求めるアルゴリズム。

参考: https://qiita.com/drken/items/b97ff231e43bce50199a#3-4-拡張ユークリッドの互除法のアルゴリズム的記述

## コード
```python
# ax + by = d
# a = qb + r (r = a % b, q = a // b)
# (qb+r)x + by = d　⇔　b(qx+y) + rx = d
# bs + rt = d
# qx + y = s, x = t　⇔　x = t, y = s − qt
# return x, y
def ex_euclidean(a, b):
    if b == 0:
        return (1, 0)
    else:
        s, t = ex_euclidean(b, a % b)
        q = a // b
        return (t, s - q * t)

def modinv(a, m):
   x, y = ex_euclidean(a, m)
   return x % m

e1 = 11
e2 = 13
N = 236934049743116267137999082243372631809789567482083918717832642810097363305512293474568071369055296264199854438630820352634325357252399203160052660683745421710174826323192475870497319105418435646820494864987787286941817224659073497212768480618387152477878449603008187097148599534206055318807657902493850180695091646575878916531742076951110529004783428260456713315007812112632429296257313525506207087475539303737022587194108436132757979273391594299137176227924904126161234005321583720836733205639052615538054399452669637400105028428545751844036229657412844469034970807562336527158965779903175305550570647732255961850364080642984562893392375273054434538280546913977098212083374336482279710348958536764229803743404325258229707314844255917497531735251105389366176228741806064378293682890877558325834873371615135474627913981994123692172918524625407966731238257519603614744577
c1 = 80265690974140286785447882525076768851800986505783169077080797677035805215248640465159446426193422263912423067392651719120282968933314718780685629466284745121303594495759721471318134122366715904
c2 = 14451037575679461333658489727928902053807202350950440400755535465672646289383249206721118279217195146247129636809289035793102103248547070620691905918862697416910065303500798664102685376006097589955370023822867897020714767877873664

# c1x + c2y = 1 なる x, y を求める
x, y = ex_euclidean(e1, e2)
if x < 0:
    x = -x
    c1 = modinv(c1, N)
else:
    y = -y
    c2 = modinv(c2, N)

# v = c1^x, w = c2^y
v = pow(c1, x, N)
w = pow(c2, y, N)
print((v*w) % N)
```

このコードを実行することで、フラグ `cpaw{424311244315114354}` を得る。
